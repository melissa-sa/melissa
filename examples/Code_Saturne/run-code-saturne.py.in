#!/usr/bin/python3

# Copyright (c) 2017, Institut National de Recherche en Informatique et en Automatique (Inria)
#               2017, EDF (https://www.edf.fr/)
#               2020, 2021 Institut National de Recherche en Informatique et en Automatique (Inria)
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
#
# * Redistributions of source code must retain the above copyright notice,
#   this list of conditions and the following disclaimer.
#
# * Redistributions in binary form must reproduce the above copyright
#   notice, this list of conditions and the following disclaimer in the
#   documentation and/or other materials provided with the distribution.
#
# * Neither the name of the copyright holder nor the names of its
#   contributors may be used to endorse or promote products derived from
#   this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
# IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
# TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
# PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
# HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
# TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

from lxml import etree
import os
import shutil
import subprocess
import sys
import warnings

example_directory = "@CMAKE_CURRENT_SOURCE_DIR@"
cs_id = "melissa"


def code_saturne(sid, param, stage):
    cmd = [
        "code_saturne", "run", "--id={:s}".format(cs_id),
        "--param={:s}".format(param), stage
    ]

    subprocess.run(cmd,
                   stdin=subprocess.DEVNULL,
                   stdout=subprocess.DEVNULL,
                   stderr=subprocess.PIPE,
                   check=True)


def get_working_directory(sid):
    working_directory_name = "workspace-{:d}".format(sid)
    working_directory = os.path.abspath(working_directory_name)

    return working_directory


def initialize(sid):
    working_directory = get_working_directory(sid)

    # set up working directory
    # erase existing directories to ensure no outdated files are used
    if os.path.exists(working_directory):
        shutil.rmtree(working_directory)

    os.mkdir(working_directory)
    shutil.copytree(os.path.join(example_directory, "MESH"),
                    os.path.join(working_directory, "MESH"))

    for subdir in ["DATA", "RESU", "SCRIPTS", "SRC"]:
        os.mkdir(os.path.join(working_directory, subdir))

    # set up Code_Saturne XML input
    input_xml_path = os.path.join(example_directory, "DATA", "case1.xml")
    output_xml_path = os.path.join(working_directory, "DATA", "case1.xml")

    # copy command line parameters directly into Code_Saturne input to avoid
    # having to bother about the number of digits when printing floating-point
    # numbers
    temperature_str = sys.argv[2]
    molecular_viscosity_str = sys.argv[3]
    # sanity check for input
    float(temperature_str)
    float(molecular_viscosity_str)

    if len(sys.argv) > 4:
        warnings.warn("expected 4 arguments, got {:d}".format(len(sys.argv)))

    tree = etree.parse(input_xml_path)
    root = tree.getroot()
    root.find('thermophysical_models') \
        .find('thermal_scalar') \
        .find('variable') \
        .find('formula') \
        .text = "temperature = {:s};".format(temperature_str)

    root.find("physical_properties") \
        .find("fluid_properties") \
        .find("property/[@name='molecular_viscosity']") \
        .find("initial_value") \
        .text = molecular_viscosity_str

    root.find("analysis_control") \
        .find("output") \
        .find("writer/[@label='melissa']") \
        .find("format/[@name='melissa']") \
        .set("options", os.getenv("MELISSA_SIMU_ID"))

    xml_header = '<?xml version="1.0" encoding="utf-8"?>'.encode()
    xml_body = etree.tostring( \
        root, encoding="utf-8", pretty_print=True, xml_declaration=False)
    output_xml = xml_header + xml_body

    with open(output_xml_path, 'xb') as f:
        f.write(output_xml)

    os.chdir(working_directory)
    code_saturne(sid, "case1.xml", "--initialize")


def execute(sid):
    working_directory = get_working_directory(sid)
    os.chdir(working_directory)

    # flush output buffers before calling `execvp` for otherwise output is lost
    sys.stdout.flush()
    sys.stderr.flush()

    # run Code_Saturne
    run_solver = os.path.join(working_directory, "RESU", cs_id, "run_solver")
    os.execvp(run_solver, [run_solver])


def main():
    stage = sys.argv[1]
    # get simulation ID
    maybe_sid_str = os.getenv("MELISSA_SIMU_ID")

    if maybe_sid_str is None:
        raise RuntimeError("environment variable MELISSA_SIMU_ID not set")

    sid = int(maybe_sid_str)

    if stage == "initialize":
        return initialize(sid)
    elif stage == "execute":
        return execute(sid)
    else:
        raise RuntimeError("unknown stage '{:s}'".format(stage))


if __name__ == "__main__":
    # If main returns a string, then `sys.exit()` will take this to mean that
    # the string is an error message, print it, and exit with a non-zero
    # status.
    sys.exit(main())
